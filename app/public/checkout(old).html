<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <style>
        #cardview-container {
            height: 40px;
            width: 300px;
            border: 1px solid gray;
            margin: 5px 0;
            padding: 5px;
        }
    </style>
    <title>Check Out</title>
</head>

<body>
    <h3>安安，幾歲住哪？有信用卡嗎？</h3>
    <div id="cardview-container"></div>
    <button id="submit-button" onclick="onClick()">給我錢！</button>
    <h4>訂單資訊</h4>
    <label>送貨方式：</label><input type="text" name="shipping" id="shipping" value="delivery"><br>
    <label>付款方式：</label><input type="text" name="payment" id="payment" value="credit_card"><br>
    <label>購買金額：</label><input type="number" name="subtotal" id="subtotal" value="1321" min="0"><br>
    <label>送貨運費：</label><input type="number" name="freight" id="freight" value="14" min="0"><br>
    <label>總共金額：</label><input type="number" name="total" id="total" value="1335" min="0"><br>
    <h4>收貨人資訊</h4>
    <label>名字：</label><input type="text" name="name" id="name" value="活人"><br>
    <label>電話：</label><input type="tel" name="phone" id="phone" value="0987654321"><br>
    <label>Email：</label><input type="email" name="email" id="email" value="test@test.com"><br>
    <label>地址: </label><input type="text" name="address" id="address" value="你心裡"><br>
    <label>送貨時間: </label><input type="text" name="time" id="time" value="夢醒時分"><br>
    <h4>購買資訊</h4>
    <label>產品ID：</label><input id="product_id" type="number" name="product_id" value="1221133" min="0" max="9999999999" /><br>
    <label>產品名稱：</label><input id="product_name" type="text" name="product_name" value="好漂漂長裙" /><br>
    <label>產品價格：</label><input id="product_price" type="number" name="product_price" value="1321" min="0"/><br>
    <label>產品顏色：</label><input id="product_color" type="text" name="product_color" value="yellow" /><br>
    <label>產品色碼：</label><input id="product_colorcode" type="text" name="product_colorcode" value="111111" /><br>
    <label>產品尺寸：</label><input id="product_size" type="text" name="product_size" value="small" /><br>
    <label>購買數量：</label><input id="product_qty" type="text" name="product_qty" value="1" max="100" min="0"/><br>
    <script src="https://js.tappaysdk.com/tpdirect/v5"></script>
    <script>
        // 設置好等等 GetPrime 所需要的金鑰
        TPDirect.setupSDK(12348, 'app_pa1pQcKoY22IlnSXq5m5WP5jFKzoRG58VEXpT7wU62ud7mMbDOGzCYIlzzLF', 'sandbox');
        // 把 TapPay 內建輸入卡號的表單給植入到 div 中
        TPDirect.card.setup('#cardview-container');

        const submitButton = document.querySelector('#submit-button');

        // call TPDirect.card.getPrime when user submit form to get tappay prime

        function onClick() {
            // 讓 button click 之後觸發 getPrime 方法
            TPDirect.card.getPrime(function (result) {
                if (result.status !== 0) {
                    console.err('getPrime 錯誤');
                    return;
                }
                const prime = result.card.prime;
                // alert('getPrime 成功: ' + prime);

                // Assemble API Object

                // Get info from input boxes
                const shippingValue = document.getElementById('shipping').value;
                const paymentValue = document.getElementById('payment').value;
                const subtotalValue = document.getElementById('subtotal').value;
                const freightValue = document.getElementById('freight').value;
                const totalValue = document.getElementById('total').value;
                // Recipient Object info
                const nameValue = document.getElementById('name').value;
                const phoneValue = document.getElementById('phone').value;
                const emailValue = document.getElementById('email').value;
                const addressValue = document.getElementById('address').value;
                const timeValue = document.getElementById('time').value;
                // List_item Object value
                const product_idValue = document.getElementById('product_id').value;
                const product_nameValue = document.getElementById('product_name').value;
                const product_priceValue = document.getElementById('product_price').value;
                const product_colorValue = document.getElementById('product_color').value;
                const product_colorcodeValue = document.getElementById('product_colorcode').value;
                const product_sizeValue = document.getElementById('product_size').value;
                const product_qtyValue = document.getElementById('product_qty').value;

                // eslint-disable-next-line camelcase
                const sendAPI_Object = {
                    prime: prime,
                    order: {
                        shipping: shippingValue,
                        payment: paymentValue,
                        subtotal: subtotalValue,
                        freight: freightValue,
                        total: totalValue,
                    },
                    list: [],
                };

                // Put info into order object
                sendAPI_Object.order.recipient = {
                    name: nameValue,
                    phone: phoneValue,
                    email: emailValue,
                    address: addressValue,
                    time: timeValue,
                };

                // Put info into listItem object
                let listItem = {
                    id: product_idValue,
                    name: product_nameValue,
                    price: product_priceValue,
                    color: {
                        code: product_colorcodeValue,
                        name: product_colorValue,
                    },
                    size: product_sizeValue,
                    qty: product_qtyValue,
                }

                // Add item into list
                sendAPI_Object.list.push(listItem);

                // Get user token
                let userToken;

                // Make sign-in request
                let signinRequest = new XMLHttpRequest();
                signinRequest.open("POST", "/api/V1.0/user/signin", true);

                //发送合适的请求头信息
                signinRequest.setRequestHeader("Content-Type", "application/json");

                signinRequest.onload = function (sendback) {
                    // 请求结束后,在此处写处理代码 
                    const sendbackJSON = JSON.parse(sendback.target.response);
                    userToken = sendbackJSON.data.access_token

                    // *****************
                    // Make checkout request
                    let checkoutRequest = new XMLHttpRequest();
                    checkoutRequest.open("POST", "/api/V1.0/order/checkout", true);

                    //发送合适的请求头信息
                    checkoutRequest.setRequestHeader("Content-Type", "application/json");
                    checkoutRequest.setRequestHeader("Authorization", "Bearer " + userToken);

                    checkoutRequest.onload = function (sendback) {
                        // 请求结束后,在此处写处理代码 
                        console.log(sendback.target.response);
                    };
                    checkoutRequest.send(JSON.stringify(sendAPI_Object));

                };
                signinRequest.send(JSON.stringify({
                    "provider": "native",
                    "email": "test111@test.com",
                    "password": "test"
                }));


            });
        }
    </script>
</body>

</html>